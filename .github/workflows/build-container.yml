name: Build and Publish Container

on:
  push:
    branches: [ main ]
    tags:
      - '*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      matrix:
        image:
          - name: cachet-status-page
            dockerfile: cachet-configuration-files/Dockerfile
            path: cachet-configuration-files
          - name: middleware-status-page
            path: middleware
            dockerfile: middleware/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tags
        id: tags
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          IMAGE=ghcr.io/${GITHUB_REPOSITORY_OWNER}/${{ matrix.image.name }}
          # Default tag is sha
          echo "tags=${IMAGE}:sha-${SHORT_SHA}" >> $GITHUB_OUTPUT

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tags=${IMAGE}:sha-${SHORT_SHA},${IMAGE}:${TAG_NAME}" >> $GITHUB_OUTPUT
          elif [[ "$GITHUB_REF" == refs/heads/main ]]; then
            echo "tags=${IMAGE}:sha-${SHORT_SHA},${IMAGE}:latest" >> $GITHUB_OUTPUT
          else
            # sanitize branch name: replace / with - and remove non-alphanum ._- characters
            BRANCH=${GITHUB_REF#refs/heads/}
            SAFE_BRANCH=$(echo "$BRANCH" | sed 's#[^A-Za-z0-9._-]#-#g')
            echo "tags=${IMAGE}:sha-${SHORT_SHA},${IMAGE}:${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.image.path }}
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
