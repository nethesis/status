version: '3.8'

networks:
  cachet-network:
    driver: bridge

volumes:
  traefik-certs:
    driver: local
  cachet-db:
    driver: local
  cachet-storage:
    driver: local

services:
  # PostgreSQL Database for Cachet
  postgres:
    image: docker.io/library/postgres:18.1-alpine
    container_name: cachet-postgres
    restart: unless-stopped
    networks:
      - cachet-network
    environment:
      POSTGRES_DB: ${DB_DATABASE:-cachet}
      POSTGRES_USER: ${DB_USERNAME:-cachet}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
    volumes:
      - cachet-db:/var/lib/postgresql/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-cachet}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Cachet Application
  cachet:
    image: ghcr.io/nethesis/cachet-status-page:${CACHET_TAG:-latest}
    container_name: cachet-app
    restart: unless-stopped
    networks:
      - cachet-network
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Application (from podman-setup/.env - HIGHEST PRIORITY)
      - APP_NAME=${APP_NAME:-Cachet}
      - APP_ENV=${APP_ENV:-local}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG:-true}
      - APP_URL=${APP_URL}
      - ASSET_URL=${ASSET_URL:-}
      - APP_FORCE_HTTPS=${APP_FORCE_HTTPS:-false}
      - APP_TIMEZONE=${APP_TIMEZONE:-UTC}
      - CACHET_ADMIN_NAME=${CACHET_ADMIN_NAME}
      - CACHET_ADMIN_USERNAME=${CACHET_ADMIN_USERNAME}
      - CACHET_ADMIN_PASSWORD=${CACHET_ADMIN_PASSWORD}
      
      # Database (from podman-setup/.env - HIGHEST PRIORITY)
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      
      # Cache & Session
      - CACHE_STORE=database
      - SESSION_DRIVER=database
      - QUEUE_CONNECTION=database
      
      # Cachet specific
      - CACHET_BEACON=${CACHET_BEACON:-false}
      - CACHET_EMOJI=${CACHET_EMOJI:-true}
      - CACHET_TRUSTED_PROXIES=*
    volumes:
      - cachet-storage:/var/www/html/storage
      - ./cachet/.env:/var/www/html/.env:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Python Middleware - Webhook Handler
  middleware:
    image: ghcr.io/nethesis/middleware-status-page:${MIDDLEWARE_TAG:-latest}
    container_name: cachet-middleware
    restart: unless-stopped
    networks:
      - cachet-network
    depends_on:
      cachet:
        condition: service_healthy
    environment:
      # Cachet API configuration
      - CACHET_API_URL=${CACHET_API_URL:-http://cachet/api/v1}
      - CACHET_API_TOKEN=${CACHET_API_TOKEN:-secret}
      # Python app settings
      - FLASK_ENV=production
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-local}
    volumes:
      # Mount config files as read-only
      - ./middleware/config.json:/app/config.json:ro,z
      - ./middleware/prometheus.yml:/app/prometheus.yml:ro,z
    healthcheck:
      test: ["CMD", "python3", "/app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Traefik - Reverse Proxy with Let's Encrypt
  traefik:
    image: docker.io/library/traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    networks:
      - cachet-network
    ports:
      - "${HTTP_PORT:-8080}:80"     # HTTP entrypoint
      - "${HTTPS_PORT:-8443}:443"   # HTTPS entrypoint
    volumes:
      - ./traefik/traefik.${ENVIRONMENT:-local}.yml:/etc/traefik/traefik.yml:ro,z
      - ./traefik/dynamic:/etc/traefik/dynamic:ro,z
      - traefik-certs:/letsencrypt
    environment:
      - TZ=${TZ:-Europe/Rome}
      - ENVIRONMENT=${ENVIRONMENT:-local}
      - CACHET_DOMAIN=${CACHET_DOMAIN:-localhost}
      - WEBHOOK_DOMAIN=${WEBHOOK_DOMAIN:-localhost}
      - CERT_RESOLVER=${CERT_RESOLVER:-letsencrypt}
      - WEBHOOK_BASIC_AUTH=${WEBHOOK_BASIC_AUTH}
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
