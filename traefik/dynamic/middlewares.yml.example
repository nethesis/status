# Traefik Dynamic Configuration
# Middlewares for authentication, rate limiting, security headers, etc.
#
# IMPORTANT: Copy this file to middlewares.yml and configure the authentication
# cp traefik/dynamic/middlewares.yml.example traefik/dynamic/middlewares.yml
#
# The deploy.sh script will automatically generate the webhook-auth hash from .env

http:
  middlewares:
  
    # BasicAuth middleware for /webhook endpoint
    webhook-auth:
      basicAuth:
        users:
          # This will be automatically generated from .env variables:
          # WEBHOOK_USERNAME and WEBHOOK_PASSWORD
          # The deploy.sh script will hash the password and update this line
          - "WEBHOOK_CREDENTIALS_PLACEHOLDER"
    
    # HTTPS redirect middleware
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true
    
    # Forward HTTPS headers to Laravel
    https-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Port: "443"
          X-Forwarded-For: ""  # Let Traefik handle this automatically
          X-Forwarded-Host: ""  # Let Traefik handle this automatically
          X-Forwarded-Ssl: "on"
        sslRedirect: false  # Already handled by redirect-to-https middleware
        forceSTSHeader: false
        sslProxyHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Ssl: "on"
    
    # Security headers
    security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "same-origin"
        customResponseHeaders:
          X-Robots-Tag: "noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex"
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
    
    # Rate limiting for webhook (optional)
    webhook-rate-limit:
      rateLimit:
        average: 100  # requests per second
        burst: 50     # burst size
        period: 1s
    
    # Compress responses
    compression:
      compress: {}
